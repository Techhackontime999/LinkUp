{% extends "base.html" %}

{% block content %}
<div class="max-w-4xl mx-auto pt-6 px-4">
    <!-- Back to Feed -->
    <div class="mb-4">
        <a href="{% url 'feed' %}" class="text-purple-600 hover:text-purple-700 flex items-center space-x-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
            <span>Back to Feed</span>
        </a>
    </div>

    <!-- Post Card -->
    <div class="post-card animate-fade-in">
        <div class="post-author">
            <div class="post-avatar">
                {{ post.user.username|slice:":2"|upper }}
            </div>
            <div class="flex-1">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="font-bold text-gray-800 hover:text-purple-600 transition-colors">
                            <a href="{% url 'public_profile' post.user.username %}">{{ post.user.username }}</a>
                        </h3>
                        <p class="text-xs text-gray-500">{{ post.created_at|timesince }} ago</p>
                    </div>
                    {% if post.user != request.user %}
                    <button
                        class="btn-follow {% if post.user in request.user.following.all %}following{% else %}not-following{% endif %} px-4 py-1.5 text-xs"
                        data-user-id="{{ post.user.id }}">
                        <span class="follow-text">{% if post.user in request.user.following.all %}Following{% else
                            %}Follow{% endif %}</span>
                    </button>
                    {% endif %}
                </div>
            </div>
            {% if post.user == request.user %}
            <div class="relative post-menu-container">
                <button class="text-gray-400 hover:text-gray-600 transition-colors post-menu-btn"
                    data-post-id="{{ post.id }}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z" />
                    </svg>
                </button>
                <!-- Dropdown Menu -->
                <div class="post-menu hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-10"
                    data-post-id="{{ post.id }}">
                    <a href="{% url 'feed' %}"
                        class="w-full text-left px-4 py-2 text-sm text-blue-600 hover:bg-blue-50 flex items-center space-x-2 border-b border-gray-100">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                        <span>Edit on Feed</span>
                    </a>
                    <button
                        class="delete-post-btn w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 rounded-b-lg flex items-center space-x-2"
                        data-post-id="{{ post.id }}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                        <span>Delete Post</span>
                    </button>
                </div>
            </div>
            {% endif %}
        </div>

        <div class="post-content">{{ post.content|safe }}</div>

        <div class="post-media-container space-y-4">
            {% if post.image %}
            <div class="post-image">
                <img src="{{ post.image.url }}" alt="Post image" class="w-full h-auto rounded-lg" />
            </div>
            {% endif %}

            {% if post.video %}
            <div class="post-video">
                <video controls class="w-full h-auto rounded-lg shadow-inner bg-black">
                    <source src="{{ post.video.url }}" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            </div>
            {% endif %}

            {% if post.audio %}
            <div class="post-audio p-4 bg-gray-50 rounded-lg">
                <audio controls class="w-full">
                    <source src="{{ post.audio.url }}" type="audio/mpeg">
                    Your browser does not support the audio element.
                </audio>
            </div>
            {% endif %}

            {% if post.pdf %}
            <div class="post-pdf p-4 bg-white border border-gray-200 rounded-lg flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-500" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                    </svg>
                    <div>
                        <p class="text-sm font-medium text-gray-800">Document (PDF)</p>
                        <p class="text-xs text-gray-500">{{ post.pdf.name|truncatechars:30 }}</p>
                    </div>
                </div>
                <a href="{{ post.pdf.url }}" target="_blank"
                    class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition-colors">
                    View / Download
                </a>
            </div>
            {% endif %}
        </div>

        <div class="flex items-center justify-between pt-3 border-t border-gray-100">
            <button class="like-btn {% if request.user in post.likes.all %}liked{% endif %}"
                data-post-id="{{ post.id }}">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5"
                    fill="{% if request.user in post.likes.all %}currentColor{% else %}none{% endif %}"
                    viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5" />
                </svg>
                <span class="like-count font-medium">{{ post.total_likes }}</span>
            </button>
            <button
                class="comment-btn flex items-center space-x-2 px-3 py-2 rounded-lg hover:bg-gray-50 transition-colors text-gray-600"
                data-post-id="{{ post.id }}">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                </svg>
                <span class="text-sm font-medium">Comment</span>
                <span class="comment-count text-xs">{{ post.total_comments }}</span>
            </button>
            <button
                class="share-btn flex items-center space-x-2 px-3 py-2 rounded-lg hover:bg-gray-50 transition-colors text-gray-600"
                data-post-id="{{ post.id }}">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                </svg>
                <span class="text-sm font-medium">Share</span>
            </button>
        </div>

        <!-- Comments Section (Always Visible on Detail Page) -->
        <div class="comments-section border-t border-gray-100 pt-3 mt-3" data-post-id="{{ post.id }}">
            <h4 class="font-semibold text-gray-800 mb-3">Comments ({{ comments.count }})</h4>

            <!-- Comments List -->
            <div class="comments-list space-y-3 mb-3 max-h-96 overflow-y-auto">
                {% for comment in comments %}
                <div class="flex items-start space-x-3">
                    <div class="flex-shrink-0">
                        <div
                            class="flex items-center justify-center w-8 h-8 rounded-full bg-gradient-primary text-white font-semibold text-sm">
                            {{ comment.user.username|slice:":2"|upper }}
                        </div>
                    </div>
                    <div class="flex-1 bg-gray-50 rounded-lg p-3">
                        <div class="flex items-center justify-between mb-1">
                            <span class="font-semibold text-sm text-gray-800">{{ comment.user.username }}</span>
                            <span class="text-xs text-gray-500">{{ comment.created_at|timesince }} ago</span>
                        </div>
                        <p class="text-sm text-gray-700">{{ comment.content }}</p>
                    </div>
                </div>
                {% empty %}
                <p class="text-gray-500 text-sm text-center py-4">No comments yet. Be the first to comment!</p>
                {% endfor %}
            </div>

            <!-- Add Comment Form -->
            <div class="flex items-start space-x-3">
                <div class="flex-shrink-0">
                    <div
                        class="flex items-center justify-center w-8 h-8 rounded-full bg-gradient-primary text-white font-semibold text-sm">
                        {{ request.user.username|slice:":2"|upper }}
                    </div>
                </div>
                <div class="flex-1">
                    <form class="comment-form" data-post-id="{{ post.id }}">
                        {% csrf_token %}
                        <textarea name="content"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none"
                            rows="2" placeholder="Write a comment..." maxlength="500" required></textarea>
                        <div class="flex justify-end mt-2">
                            <button type="submit" class="btn-primary text-sm">Post Comment</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Like functionality
        const likeBtn = document.querySelector('.like-btn');
        if (likeBtn) {
            likeBtn.addEventListener('click', function () {
                const postId = this.dataset.postId;
                const likeCountSpan = this.querySelector('.like-count');
                const svgIcon = this.querySelector('svg');
                fetch(`/like/${postId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    },
                })
                    .then(response => response.json())
                    .then(data => {
                        likeCountSpan.textContent = data.likes_count;
                        if (data.is_liked) {
                            svgIcon.setAttribute('fill', 'currentColor');
                            this.classList.add('liked');
                        } else {
                            svgIcon.setAttribute('fill', 'none');
                            this.classList.remove('liked');
                        }
                    });
            });
        }

        // Follow functionality
        const followBtn = document.querySelector('.btn-follow');
        if (followBtn) {
            followBtn.addEventListener('click', function () {
                const userId = this.dataset.userId;
                const textSpan = this.querySelector('.follow-text');
                fetch(`/network/follow/${userId}/?ajax=1`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.is_following) {
                            this.classList.replace('not-following', 'following');
                            textSpan.textContent = 'Following';
                        } else {
                            this.classList.replace('following', 'not-following');
                            textSpan.textContent = 'Follow';
                        }
                    });
            });
        }

        // Post menu toggle (3-dot menu)
        const postMenuBtn = document.querySelector('.post-menu-btn');
        if (postMenuBtn) {
            postMenuBtn.addEventListener('click', function (e) {
                e.stopPropagation();
                const postId = this.dataset.postId;
                const menu = document.querySelector(`.post-menu[data-post-id="${postId}"]`);
                menu.classList.toggle('hidden');
            });
        }

        // Close menu when clicking outside
        document.addEventListener('click', function (e) {
            if (!e.target.closest('.post-menu-container')) {
                const menu = document.querySelector('.post-menu');
                if (menu) menu.classList.add('hidden');
            }
        });

        // Delete post functionality
        const deletePostBtn = document.querySelector('.delete-post-btn');
        if (deletePostBtn) {
            deletePostBtn.addEventListener('click', function () {
                const postId = this.dataset.postId;

                // Confirm deletion
                if (!confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
                    return;
                }

                fetch(`/post/${postId}/delete/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    },
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Redirect to feed after successful deletion
                            window.location.href = '{% url "feed" %}';
                        } else {
                            alert('Failed to delete post. Please try again.');
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting post:', error);
                        alert('Failed to delete post. Please try again.');
                    });
            });
        }

        // Share functionality
        const shareBtn = document.querySelector('.share-btn');
        if (shareBtn) {
            shareBtn.addEventListener('click', function () {
                const postId = this.dataset.postId;

                fetch(`/post/${postId}/link/`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            navigator.clipboard.writeText(data.url).then(() => {
                                const originalText = this.querySelector('span').textContent;
                                this.querySelector('span').textContent = 'Link Copied!';
                                this.classList.add('text-green-600');

                                setTimeout(() => {
                                    this.querySelector('span').textContent = originalText;
                                    this.classList.remove('text-green-600');
                                }, 2000);
                            }).catch(err => {
                                console.error('Failed to copy:', err);
                                alert('Failed to copy link. Please try again.');
                            });
                        }
                    });
            });
        }

        // Comment form submission
        const commentForm = document.querySelector('.comment-form');
        if (commentForm) {
            commentForm.addEventListener('submit', function (e) {
                e.preventDefault();
                const postId = this.dataset.postId;
                const textarea = this.querySelector('textarea');
                const content = textarea.value.trim();

                if (!content) return;

                const formData = new FormData();
                formData.append('content', content);
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                fetch(`/post/${postId}/comment/`, {
                    method: 'POST',
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Reload page to show new comment
                            location.reload();
                        }
                    })
                    .catch(error => {
                        console.error('Error posting comment:', error);
                        alert('Failed to post comment. Please try again.');
                    });
            });
        }
    });
</script>
{% endblock %}