{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/form-enhancements.css' %}">
{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto pt-6">
    <div class="premium-card p-1">
        <div class="px-8 py-10">
            <header class="mb-8">
                <h1 class="text-2xl font-bold text-gray-800 mb-2">Apply for {{ job.title }}</h1>
                <p class="text-gray-500">{{ job.company }} â€¢ {{ job.location }}</p>
            </header>

            <form method="post" enctype="multipart/form-data" class="space-y-6 form-enhanced" id="application-form" data-ajax="false" role="form" aria-labelledby="form-title" novalidate>
                {% csrf_token %}
                
                <div id="form-title" class="sr-only">Job application form for {{ job.title }} at {{ job.company }}</div>

                <!-- Form Progress Indicator -->
                <div class="form-progress-indicator" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" aria-label="Application completion progress">
                    <div class="form-progress-bar">
                        <div class="form-progress-fill" style="width: 0%" id="application-progress"></div>
                    </div>
                    <div class="form-progress-text" id="application-progress-text">Complete all required fields</div>
                </div>

                <!-- Application Materials Group -->
                <fieldset class="field-group-enhanced" role="group" aria-labelledby="application-materials-legend">
                    <legend id="application-materials-legend">Application Materials</legend>
                    
                    <div class="form-field-wrapper">
                        <label for="id_resume" class="block text-sm font-bold text-gray-700 field-required">Upload Resume</label>
                        <div class="relative">
                            <input type="file" name="resume" id="id_resume" required accept=".pdf,.doc,.docx"
                                   class="form-field-enhanced"
                                   data-validation='{"required": true}'
                                   aria-describedby="id_resume-help id_resume-validation"
                                   aria-required="true">
                            <div id="id_resume-help" class="field-help-text">Accepts PDF, DOC, or DOCX files up to 5MB. Your resume should highlight relevant experience and skills.</div>
                            <div class="field-validation-message" id="id_resume-validation" role="alert" aria-live="polite"></div>
                            <div class="field-status-indicator" id="id_resume-status" aria-hidden="true"></div>
                        </div>
                    </div>

                    <div class="form-field-wrapper">
                        <label for="id_cover_letter" class="block text-sm font-bold text-gray-700 field-required">Cover Letter</label>
                        <textarea name="cover_letter" id="id_cover_letter" rows="8" required
                                  placeholder="Tell us why you're a great fit for this role..."
                                  class="form-field-enhanced"
                                  data-validation='{"minLength": 100, "required": true}'
                                  aria-describedby="id_cover_letter-help id_cover_letter-count id_cover_letter-validation"
                                  aria-required="true"></textarea>
                        <div id="id_cover_letter-help" class="field-help-text">Write a compelling cover letter that highlights your relevant experience and enthusiasm for the role</div>
                        <div class="field-character-count" id="id_cover_letter-count" aria-live="polite">0 / 2000 characters</div>
                        <div class="field-validation-message" id="id_cover_letter-validation" role="alert" aria-live="polite"></div>
                        <div class="field-status-indicator" id="id_cover_letter-status" aria-hidden="true"></div>
                    </div>
                </fieldset>

                <hr class="form-section-divider" role="separator">

                <div class="flex items-center space-x-4 pt-4">
                    <button type="submit" class="btn-premium px-10 py-3 text-lg w-full md:w-auto" id="submit-btn" aria-describedby="submit-help">
                        Submit Application
                    </button>
                    <div id="submit-help" class="sr-only">Submit your application for {{ job.title }} at {{ job.company }}</div>
                    <a href="{% url 'jobs:job_detail' job.pk %}"
                        class="text-gray-500 font-bold hover:text-gray-700 transition-colors focus:text-gray-700 focus:underline"
                        aria-label="Cancel application and return to job details">Back</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Character count for cover letter
    const coverLetterTextarea = document.getElementById('id_cover_letter');
    const coverLetterCounter = document.getElementById('id_cover_letter-count');
    
    if (coverLetterTextarea && coverLetterCounter) {
        function updateCoverLetterCount() {
            const length = coverLetterTextarea.value.length;
            coverLetterCounter.textContent = `${length} / 2000 characters`;
            
            // Update styling based on length
            coverLetterCounter.classList.remove('near-limit', 'over-limit');
            if (length > 1800) {
                coverLetterCounter.classList.add('near-limit');
            }
            if (length > 2000) {
                coverLetterCounter.classList.add('over-limit');
            }
            
            // Announce when approaching or exceeding limit
            if (length === 1800) {
                window.a11y?.announceStatus('Approaching character limit: 1800 of 2000 characters used');
            } else if (length === 2000) {
                window.a11y?.announceStatus('Character limit reached: 2000 characters');
            } else if (length > 2000) {
                window.a11y?.announceStatus(`Character limit exceeded: ${length} of 2000 characters`);
            }
        }
        
        coverLetterTextarea.addEventListener('input', updateCoverLetterCount);
        updateCoverLetterCount(); // Initial count
    }
    
    // File upload enhancement
    const fileInput = document.getElementById('id_resume');
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            const validationMessage = document.getElementById('id_resume-validation');
            
            if (file) {
                // Validate file size (5MB limit)
                if (file.size > 5 * 1024 * 1024) {
                    if (validationMessage) {
                        validationMessage.textContent = 'File size must be less than 5MB';
                        validationMessage.className = 'field-validation-message validation-error';
                    }
                    e.target.value = ''; // Clear the input
                    window.a11y?.announceStatus('Error: File size must be less than 5MB');
                    return;
                }
                
                // Validate file type
                const allowedTypes = ['.pdf', '.doc', '.docx'];
                const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
                if (!allowedTypes.includes(fileExtension)) {
                    if (validationMessage) {
                        validationMessage.textContent = 'Please upload a PDF, DOC, or DOCX file';
                        validationMessage.className = 'field-validation-message validation-error';
                    }
                    e.target.value = ''; // Clear the input
                    window.a11y?.announceStatus('Error: Please upload a PDF, DOC, or DOCX file');
                    return;
                }
                
                // Show success message
                if (validationMessage) {
                    const fileSizeMB = (file.size / 1024 / 1024).toFixed(2);
                    validationMessage.textContent = `Selected: ${file.name} (${fileSizeMB} MB)`;
                    validationMessage.className = 'field-validation-message validation-success';
                }
                window.a11y?.announceStatus(`Resume file selected: ${file.name}`);
            } else {
                // Clear validation message when no file selected
                if (validationMessage) {
                    validationMessage.textContent = '';
                    validationMessage.className = 'field-validation-message';
                }
            }
        });
        
        // Add drag and drop support with accessibility
        fileInput.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.classList.add('drag-over');
        });
        
        fileInput.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.classList.remove('drag-over');
        });
        
        fileInput.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.classList.remove('drag-over');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                this.files = files;
                // Trigger change event
                const changeEvent = new Event('change', { bubbles: true });
                this.dispatchEvent(changeEvent);
            }
        });
    }
    
    // Form submission announcement
    document.getElementById('application-form').addEventListener('submit', function() {
        window.a11y?.announce('Submitting job application. Please wait for confirmation.', 'assertive');
    });
    
    // Form progress tracking
    function updateApplicationProgress() {
        const form = document.getElementById('application-form');
        const requiredFields = form.querySelectorAll('[required]');
        const progressBar = document.getElementById('application-progress');
        const progressText = document.getElementById('application-progress-text');
        const progressContainer = progressBar?.closest('[role="progressbar"]');
        
        let completedFields = 0;
        requiredFields.forEach(field => {
            if (field.type === 'file') {
                if (field.files && field.files.length > 0) {
                    completedFields++;
                }
            } else if (field.value.trim() !== '') {
                completedFields++;
            }
        });
        
        const progress = (completedFields / requiredFields.length) * 100;
        if (progressBar) {
            progressBar.style.width = `${progress}%`;
        }
        
        // Update ARIA attributes
        if (progressContainer) {
            progressContainer.setAttribute('aria-valuenow', Math.round(progress));
        }
        
        if (progressText) {
            if (progress === 100) {
                progressText.textContent = 'Ready to submit!';
                window.a11y?.announceStatus('All required fields completed. Application is ready to submit.');
            } else {
                const remaining = requiredFields.length - completedFields;
                progressText.textContent = `${remaining} required field${remaining !== 1 ? 's' : ''} remaining`;
            }
        }
    }
    
    // Listen for field changes to update progress
    document.addEventListener('input', function(e) {
        if (e.target.closest('#application-form')) {
            updateApplicationProgress();
        }
    });
    
    document.addEventListener('change', function(e) {
        if (e.target.closest('#application-form')) {
            updateApplicationProgress();
        }
    });
    
    // Initial progress update
    updateApplicationProgress();
    
    // Announce form purpose on load
    window.a11y?.announce('Job application form loaded. Please complete all required fields to submit your application.');
});
</script>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/form-enhancements.js' %}"></script>
{% endblock %}